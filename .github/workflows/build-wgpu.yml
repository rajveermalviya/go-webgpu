name: Build wgpu-native

on: [workflow_dispatch]

env:
  WGPU_COMMIT: c45b65eb9c33d3311960194e41b045ccafc5e4e6
  ANDROID_NDK_VERSION: "22.1.7171670"
  ANDROID_API_LEVEL: "21"

jobs:
  build-wgpu:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    env:
      CARGO_BUILD_TARGET: ${{ matrix.target }}
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: build - linux/amd64
            os: ubuntu-latest
            toolchain: stable
            target: x86_64-unknown-linux-gnu
            goos: linux
            goarch: amd64

          - name: build - linux/386
            os: ubuntu-latest
            toolchain: stable
            target: i686-unknown-linux-gnu
            goos: linux
            goarch: "386"
            setup_env: |
              sudo apt update -y;
              sudo apt install -y gcc-multilib;

          - name: build - windows/amd64
            os: windows-latest
            toolchain: stable-gnu
            target: x86_64-pc-windows-gnu
            goos: windows
            goarch: amd64
            setup_env: |
              choco install -y --force llvm | exit 0
              echo "LIBCLANG_PATH=C:\Program Files\LLVM\lib" >> $GITHUB_ENV

          - name: build - windows/386
            os: windows-latest
            toolchain: stable-i686-pc-windows-gnu
            target: i686-pc-windows-gnu
            goos: windows
            goarch: "386"
            setup_env: |
              choco install -y --force --x86 llvm | exit 0
              echo "LIBCLANG_PATH=C:\Program Files (x86)\LLVM\lib" >> $GITHUB_ENV

          - name: build - darwin/amd64
            os: macos-latest
            toolchain: stable
            target: x86_64-apple-darwin
            goos: darwin
            goarch: amd64

          - name: build - darwin/arm64
            os: macos-latest
            toolchain: stable
            target: aarch64-apple-darwin
            goos: darwin
            goarch: arm64

          - name: build - android/amd64
            os: ubuntu-latest
            toolchain: stable
            target: x86_64-linux-android
            goos: android
            goarch: amd64
            setup_env: |
              set -x

              echo "LIBCLANG_PATH=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/lib64/libclang.so.11git" >> $GITHUB_ENV
              echo "LLVM_CONFIG_PATH=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-config" >> $GITHUB_ENV
              echo "BINDGEN_EXTRA_CLANG_ARGS='-isysroot $ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/sysroot/'" >> $GITHUB_ENV
              echo "CC=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/$CARGO_BUILD_TARGET$ANDROID_API_LEVEL-clang" >> $GITHUB_ENV
              echo "CLANG_PATH=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/$CARGO_BUILD_TARGET$ANDROID_API_LEVEL-clang" >> $GITHUB_ENV

              echo "CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/$CARGO_BUILD_TARGET$ANDROID_API_LEVEL-clang" >> $GITHUB_ENV

          - name: build - android/arm64
            os: ubuntu-latest
            toolchain: stable
            target: aarch64-linux-android
            goos: android
            goarch: arm64
            setup_env: |
              set -x

              echo "LIBCLANG_PATH=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/lib64/libclang.so.11git" >> $GITHUB_ENV
              echo "LLVM_CONFIG_PATH=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-config" >> $GITHUB_ENV
              echo "BINDGEN_EXTRA_CLANG_ARGS='-isysroot $ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/sysroot/'" >> $GITHUB_ENV
              echo "CC=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/$CARGO_BUILD_TARGET$ANDROID_API_LEVEL-clang" >> $GITHUB_ENV
              echo "CLANG_PATH=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/$CARGO_BUILD_TARGET$ANDROID_API_LEVEL-clang" >> $GITHUB_ENV

              echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/$CARGO_BUILD_TARGET$ANDROID_API_LEVEL-clang" >> $GITHUB_ENV

    steps:
      # Checkout
      - uses: actions/checkout@v2
      # Install rust
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.toolchain }}
          target: ${{ matrix.target }}
          default: true
      # Setup Environment
      - name: Setup Environment
        run: ${{ matrix.setup_env }}
        shell: bash
      # Build
      - name: Build
        run: |
          set -ex;
          echo $CC;
          git clone --recursive https://github.com/gfx-rs/wgpu-native.git tmp;
          cd tmp;
          git checkout $WGPU_COMMIT;
          export CARGO_PROFILE_RELEASE_LTO=true;
          export CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1;
          cargo build --release;
          ls -al target/$CARGO_BUILD_TARGET/release/;
          mkdir -p $GITHUB_WORKSPACE/wgpu/lib/$GOOS/$GOARCH;
          mv target/$CARGO_BUILD_TARGET/release/libwgpu_native.a $GITHUB_WORKSPACE/wgpu/lib/$GOOS/$GOARCH/libwgpu_native.a;
          cd ..;
          rm -rf tmp;
        shell: bash
      # Send a PR
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: Update wgpu-native static library for ${{ matrix.goos }}/${{ matrix.goarch }}
          branch-suffix: random
          title: Update wgpu-native static library for ${{ matrix.goos }}/${{ matrix.goarch }}
          body: Auto-generated pull request to build wgpu-native for ${{ matrix.goos }}/${{ matrix.goarch }}
